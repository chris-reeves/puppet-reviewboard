Puppet Reviewboard
==================

Manage an install of [Reviewboard](http://www.reviewboard.org)

To install include the package 'reviewboard' in your manifest

Create a reviewboard site based at '/var/www/reviewboard', available at ${::fqdn}/reviewboard:

    reviewboard::site {'/var/www/reviewboard':
        vhost    => "${::fqdn}",
        location => '/reviewboard'
    }

Optionally you can install the RBtool package for submitting reviews by
including 'reviewboard::rbtool'

Pre-Requisites
--------------

The Modulefile only lists the mandatory 'stdlib' dependency. The modules used
to provide the web server and database are configurable, so it is neccessary
to separately install these dependencies, e.g. for the default setup:

    puppet module install puppetlabs/apache
    puppet module install puppetlabs/postgresql

The modules available are listed below in the 'Usage' section, pull requests to
support other providers are welcome.

Usage
-----

### reviewboard class

You can change the reviewboard version installed with the 'version' argument to the
reviewboard class. Acceptable values for the version argument look like '1.7.28' or
'2.0.12'. You can find a catalog of versions at:

http://downloads.reviewboard.org/releases/ReviewBoard/.

You can change how the sites are configured with the 'provider' arguments to the reviewboard class. 

You can change which version control systems are installed using 'install_vcs'.

**version**:
  * Version of reviewboard to install

**webprovider**:
  * *puppetlabs/apache*: Use the puppetlabs/apache module to create an Apache vhost
  * *simple*: Copy the apache config file generated by reviewboard & set up a basic Apache server
  * *none*: No web provisioning is done

**dbprovider**:
  * *puppetlabs/postgresql*: Use the puppetlabs/postgresql module to create database tables & install bindings
  * *puppetlabs/mysql*: Use the puppetlabs/mysql module to create database tables & install bindings
  * *none*: No database provisioning is done (note a database is required for the install to work)

**install_vcs**:
  * *cvs*: Install CVS client
  * *svn*: Install Subversion client
  * *git*: Install git client
  * *mercurial*: Install mercurial client
  * *other*: Install another VCS client (requires **pkg_vcs_other**)

The default settings are
    
    class reviewboard {
        version     => '1.7.28',
        webprovider => 'puppetlabs/apache',
        dbprovider  => 'puppetlabs/postgresql',
        install_vcs => 'git',
    }

### reviewboard::site

You can control the path to the reviewboard install using the name of the resource, or the 'site' paramter.

You can control the URL for reviewboard using the 'vhost' and 'location' parameters.

The database parameters are largely self-explanatory.

You can turn on SSL using the 'ssl' parameter and specify certificates, and enable http -> https redirects using the 'ssl_redirect_http' parameter.

**site**
  * Filesystem path into which this instance will be installed.
  * Defaults to the name of the declared Reviewboard::Site resource.

**vhost**
  * Fully-qualified host name through which this instance will be accessed
  * Defaults to $fqdn

**location**
  * URL path to this instance, relative to the host name
  * Defaults to '/reviewboard'

**dbtype**
  * Type of database to be used. Valid values are 'postgresql' and 'mysql'.
  * Defaults to 'postgresql'

**dbname**
  * Name of the Reviewboard database.
  * Defaults to 'reviewboard'

**dbhost**
  * Hostname of the server hosting the Reviewboard database.
  * Defaults to 'localhost'

**dbuser**
  * Name of the Reviewboard database user.
  * Defaults to 'reviewboard'

**dbpass**
  * Password for the Reviewboard database user.
  * Required parameter.

**admin**
  * Name of the Reviewboard admin user.
  * Defaults to 'admin'

**adminpass**
  * Password for the Reviewboard admin user.
  * Required parameter.

**adminemail**
  * Email address of the Reviewboard admin user.
  * Defaults to $webuser@$fqdn

**company**
  * Company name (displayed by Reviewboard).
  * Defaults to the empty string.

**ssl**
  * Controls whether this instance is protected using SSL or not (boolean).
    Only supported by the puppetlabs/apache web provider.
  * Defaults to false

**ssl_key**
  * Absolute path to the SSL certificate key file. This module is not
    responsible for placing the key file on the server. Only used when 'ssl' is
    true.
  * Defaults to default system-generated certificate key.

**ssl_crt**
  * Absolute path to the SSL certificate file. This module is not responsible
    for placing the certificate file on the server. Only used when 'ssl' is
    true.
  * Defaults to default system-generated certificate.

**ssl_chain**
  * Absolute path to the SSL certificate chain file. This module is not
    responsible for placing the certificate chain file on the server. Only
    used when 'ssl' is true.
  * Defaults to undef.

**ssl_redirect_http**
  * Controls whether a redirect is configured to redirect any non-SSL traffic
    to the SSL-enabled host. Only used when 'ssl' is true.
  * Defaults to false.

Customising
-----------

The parameters described above should be sufficient in most cases, but if you
need to do something more custom then the following parameters may be of
interest.

### reviewboard class

**webuser**
  * User that should own the web folders.

**egg_url**
  * URL of Reviewboard egg to install.
  * Defaults to a URL built from the version parameter.

**pkg_python_pip**
  * Package or (array of) packages to install for pip and easy_install.
  * Default is OS-dependent.

**pkg_python_dev**
  * Package or (array of) packages to install for python headers and static libs.
  * Default is OS-dependent.

**pkg_memcached**
  * Package or (array of) packages to install for memcached support. Set to the string 'NONE' if memcached support should not be installed.
  * Default is OS-dependent.

**pkg_vcs_cvs**
  * Package or (array of) packages to install for CVS support.
  * Default is OS-dependent.

**pkg_vcs_svn**
  * Package or (array of) packages to install for SVN support.
  * Default is OS-dependent.

**pkg_vcs_git**
  * Package or (array of) packages to install for git support.
  * Default is OS-dependent.

**pkg_vcs_mercurial**
  * Package or (array of) packages to install for mercurial support.
  * Default is OS-dependent.

**pkg_vcs_other**
  * Package or (array of) packages to install to support other version control systems.
  * Required parameter when 'other' is specified for install_vcs.

**rbsitepath**
  * Path to the rb-site binary.
  * Default is OS-dependent.

To use a custom web provider set the 'webuser' parameter & subscribe the web
service to `reviewboard::provider::web<||>`:

    class reviewboard {
        webprovider => 'none',
        webuser     => 'apache',
    }
    Reviewboard::Provider::Web<||> ~> Service['apache']

You will then need to manually configure your web server, Reviewboard generates
an example Apache config file in ${site}/conf/apache-wsgi.conf.

### reviewboard::site

**cache**
  * Type of cache used by reviewboard. Valid values are 'memcached' and 'file'.
  * Defaults to 'memcached'

**cacheinfo**
  * Cache identifier (memcached connection string or file cache directory).
  * Defaults to 'localhost:11211'

**webuser**
  * User that should own the web folders

Other Features
--------------

 * **RBTool**: Reviewboard command-line interface. To install:

        include reviewboard::rbtool

 * **Trac integration**: The [traclink](https://github.com/ScottWales/reviewboard-trac-link) Reviewboard plugin posts a notice on a Trac ticket whenever the 'Bug' field is set in a review. To install:

        package {trac: } # Make sure Trac is installed via Puppet
        include reviewboard::traclink

    There is also some setup required in your site's `trac.ini`:

        [ticket-custom]
        reviews = text
        reviews.format = wiki
        [interwiki]
        review = //reviewboard/r/

Testing
-------

Spec tests make use of [rsepc-puppet](http://rspec-puppet.com/) and integration tests make use of [beaker](https://github.com/puppetlabs/beaker) and [serverspec](http://serverspec.org) to check the module is applied properly on a Vagrant VM.

To setup tests

    $ gem install bundler
    $ bundle install --path vendor/bundle

then to run the tests

    $ bundle exec rake spec
    $ bundle exec rake beaker
